<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Python函数式编程系列012：惰性列表之生成器与迭代器 - 3Gee的博客</title>
  <meta name="description" content="因为本系列还是基于一些已经对Python有一定熟悉度的读者，所以我们在此不做非常多的赘述来介绍基本知识了。而是回我们之前的主题，我们要用迭代器和生成器实现之前的指数函数。">

  
  <link rel="stylesheet" href="/assets/styles/core.css?v=20220111135546">
  <link rel="stylesheet" href="/assets/styles/fontello.css?v=20220111135546">
  <link rel="stylesheet" href="/assets/styles/highlighting/murphy.css?v=20220111135546">

  <link rel="canonical" href="https://3gee.netlify.app/lambda-and-tau/2021/10/25/python_lambda%E4%B9%8B%E6%83%B0%E6%80%A7%E5%88%97%E8%A1%A84.html">
  <link rel="alternate" type="application/rss+xml" title="3Gee的博客" href="/feed.xml">

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
  <style>.MathJax_ExBox { font-family: serif; }</style>
  

  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56025474-3', 'auto');
  ga('send', 'pageview');

</script>
  

  
</head>

  <body>

  <main class="page-content" aria-label="Content">
    <div class="wrapper">
      <article class="post" lang="en" itemscope itemtype="http://schema.org/BlogPosting" >

  <header class="post-header">
  <a class="site-title" href="/">3Gee的博客</a>
  <h1 class="post-title baseline-fix" itemprop="name headline">Python函数式编程系列012：惰性列表之生成器与迭代器</h1>
</header>




  <div class="post-content" itemprop="articleBody">
    <p>因为本系列还是基于一些已经对<code class="language-plaintext highlighter-rouge">Python</code>有一定熟悉度的读者，所以我们在此不做非常多的赘述来介绍基本知识了。而是回我们之前的主题，我们要用迭代器和生成器实现之前的指数函数。</p>

<p>当然，我们这里还是需要回到惰性列表是什么这个问题。事实上，回到原来惰性求值的概念，惰性列表的概念其实是「需要时才计算出值」的列表。我们在调用<code class="language-plaintext highlighter-rouge">iter</code>的时候，其实对常见的对象并没有特别大的优势。我们可以假想，其实<code class="language-plaintext highlighter-rouge">iter</code>转化<code class="language-plaintext highlighter-rouge">[1, 2, 3, 4]</code>的结果其实如下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">yield_list</span><span class="p">():</span>
    <span class="k">yield</span> <span class="mi">1</span>
    <span class="k">yield</span> <span class="mi">2</span>
    <span class="k">yield</span> <span class="mi">3</span>
    <span class="k">yield</span> <span class="mi">4</span>
</code></pre></div></div>

<p>唯一的优势，我们之前已经提到过了，就是反复套用函数<code class="language-plaintext highlighter-rouge">f</code>和<code class="language-plaintext highlighter-rouge">g</code>时，我们是计算<code class="language-plaintext highlighter-rouge">g(f(x))</code>而不是先把列表里每个值套用<code class="language-plaintext highlighter-rouge">f</code>再套用<code class="language-plaintext highlighter-rouge">g</code>。这里有个极大的优势，就是提前终止时可以避免没有必要的运算。比如，下面一个<code class="language-plaintext highlighter-rouge">for</code>里面的例子，我们是为了发现列表<code class="language-plaintext highlighter-rouge">ls</code>中应用<code class="language-plaintext highlighter-rouge">f</code>函数后如果结果等于<code class="language-plaintext highlighter-rouge">a</code>就返回index否则返回<code class="language-plaintext highlighter-rouge">None</code>：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">find_index_apply_f</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ls</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">a</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">i</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">find_index_apply_f</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
<span class="mi">1</span>
</code></pre></div></div>

<p>现在，这里提前跳出可以减少非常多的运算量，但是如果使用一个普通列表却很难，我们在使用<code class="language-plaintext highlighter-rouge">map</code>之后必然已经全都计算了，但如果惰性求值，我们可以就在需要的时候停止就行。这个是列表操作替代循环必须实现的东西。</p>

<p>第二个惰性列表的最大应用，就是无穷列表，比如下面一个生成器，我们可以生成一个无限长度的全是<code class="language-plaintext highlighter-rouge">x</code>的列表。后面我们会聊到我们在各种场合中已经用到了这个抽象。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">yield_x_forever</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">x</span>
</code></pre></div></div>

<h2 id="实现一些常用的惰性列表操作">实现一些常用的(惰性)列表操作</h2>

<p>大部分操作迭代器/生成器的函数，我们都可以在<code class="language-plaintext highlighter-rouge">itertoools</code>中找到。但，我们这里还是要实现一些非常<strong>函数式</strong>的函数，方便以后的操作：</p>

<h3 id="1-head">1. head</h3>

<p><code class="language-plaintext highlighter-rouge">head</code>很简单，即取出(惰性)列表第一个元素：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">head</span> <span class="o">=</span> <span class="nb">next</span>
</code></pre></div></div>

<h3 id="2-take">2. take</h3>

<p><code class="language-plaintext highlighter-rouge">take</code>的目标是列表前N个值，这个可以实现成触发计算（转化成非惰性对象，一般为一个值或者列表）或者不触发计算的版本。下面我们实现的是触发计算的函数。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">take</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
    <span class="s">"""将前n个元素固定转为列表
    """</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">islice</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">n</span><span class="p">)]</span>

<span class="n">take_curry</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">it</span><span class="p">:</span> <span class="n">take</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">it</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="3-drop">3. drop</h3>

<p><code class="language-plaintext highlighter-rouge">drop</code>则相反是删去前N个值。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">drop</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
    <span class="s">"""剔除前n个元素
    """</span>
    <span class="k">return</span> <span class="n">islice</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="4-tail">4. tail</h3>

<p><code class="language-plaintext highlighter-rouge">tail</code>是删去<code class="language-plaintext highlighter-rouge">head</code>后的列表，可以用<code class="language-plaintext highlighter-rouge">drop</code>实现：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="n">tail</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">drop</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="5-iterate">5. iterate</h3>

<p><code class="language-plaintext highlighter-rouge">iterate</code>是重点要用到的函数，就是通过一个迭代函数还有初始值，实现一个无穷列表：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def iterate(f, x):
    yield x
    yield from iterate(f, f(x))
</code></pre></div></div>

<p>比如，实现所有正偶数的无穷列表：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">positive_even_number</span> <span class="o">=</span> <span class="n">iterate</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<p>当然，更简单地写法是使用<code class="language-plaintext highlighter-rouge">itertools</code>里面的<code class="language-plaintext highlighter-rouge">repeat</code>和<code class="language-plaintext highlighter-rouge">accumulate</code>：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">iterate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">accumulate</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">fx</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">fx</span><span class="p">))</span>
</code></pre></div></div>

<h2 id="简单实践">简单实践</h2>

<h3 id="例子一求指数">例子一：求指数</h3>

<p>我们回到之前求指数的例子中，我们可以实现惰性列表的版本。</p>

<p>第一个思路，我们就是直接用<code class="language-plaintext highlighter-rouge">iterate</code>从<code class="language-plaintext highlighter-rouge">x</code>开始，每次乘以<code class="language-plaintext highlighter-rouge">x</code>，然后取出前<code class="language-plaintext highlighter-rouge">n</code>个值，拿到最后一个：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">power</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="n">take</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">iterate</span><span class="p">(</span><span class="k">lambda</span> <span class="n">xx</span><span class="p">:</span> <span class="n">xx</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div></div>

<p>另一个就是先生成一个无穷长度的<code class="language-plaintext highlighter-rouge">x</code>，取出前<code class="language-plaintext highlighter-rouge">n</code>个，相乘来<code class="language-plaintext highlighter-rouge">reduce</code>：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">power</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">reduce</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> 
    <span class="n">take</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">iterate</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
<span class="p">)</span>
</code></pre></div></div>

<p>当然，我们还可以用<strong>生成器</strong>生成无穷长列表：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">yield_power</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">x</span><span class="p">):</span>
    <span class="k">yield</span> <span class="n">init</span>
    <span class="k">yield</span> <span class="k">from</span> <span class="n">yield_power</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">init</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="例子二查找">例子二：查找</h3>

<p>我们回到上面解说的例子，我们要找到一个无穷列表中套用<code class="language-plaintext highlighter-rouge">f</code>后，第一个等于<code class="language-plaintext highlighter-rouge">a</code>的值的<code class="language-plaintext highlighter-rouge">index</code>。如果不是惰性的话，这个必须提前跳出也不可能实现。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">find_a_in_lazylist</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">lls</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">head</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">a</span><span class="p">,</span> <span class="n">enumerat</span><span class="p">(</span><span class="n">lls</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div>

<h2 id="总结">总结</h2>

<p>本章回顾了利用<code class="language-plaintext highlighter-rouge">Python</code>自带的生成器、迭代器实现惰性列表，并展示如何运用这些概念做一些数据操作应用。当然在其中，我们要深刻感受到，函数式编程与数据是非常亲近的，它关注数据胜于项目结构，这点和对象式编程非常不同。大部分对象式编程的教程倾向于概述分层、结构这些概念，真是因为这个是对象式编程擅长的地方。</p>

<p>在我实现的教学项目<a href="https://github.com/threecifanggen/python-functional-programming"><code class="language-plaintext highlighter-rouge">fppy</code>(点击这里前往<code class="language-plaintext highlighter-rouge">github</code>)</a>中，我用内置的<code class="language-plaintext highlighter-rouge">python</code>模块实现了一个<code class="language-plaintext highlighter-rouge">LazyList</code>类，用它可以用链式写法完成上面的所有例子:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">power1</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="n">LazyList</span><span class="p">.</span><span class="n">from_iter</span><span class="p">(</span><span class="n">x</span><span class="p">)(</span><span class="k">lambda</span> <span class="n">xx</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">).</span><span class="n">take</span><span class="p">(</span><span class="n">n</span><span class="p">).</span><span class="n">last</span>
<span class="n">power2</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="n">LazyList</span><span class="p">.</span><span class="n">from_iter</span><span class="p">(</span><span class="n">x</span><span class="p">)(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">x</span><span class="p">).</span><span class="n">take</span><span class="p">(</span><span class="n">n</span><span class="p">).</span><span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">:</span> <span class="n">xx</span> <span class="o">*</span> <span class="n">yy</span><span class="p">)</span>

<span class="n">find_a_in_lazylist</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">lls</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">LazyList</span><span class="p">(</span><span class="n">lls</span><span class="p">)</span>\
    <span class="p">.</span><span class="n">zip_with</span><span class="p">(</span><span class="n">LazyList</span><span class="p">.</span><span class="n">from_iter</span><span class="p">(</span><span class="mi">0</span><span class="p">)(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>\
    <span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">a</span><span class="p">)</span>\
    <span class="p">.</span><span class="n">split_head</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div>

<div id="comments"></div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>

<script src="//unpkg.com/valine/dist/Valine.min.js"></script>

<script>
    new Valine({
        el: '#comments',
        app_id: 'qrAQjOGaeAWqza9Eb2aLJBg8-gzGzoHsz',
        app_key: 'UYnglEGtJuNEqBaQwYmH8cPY',
        placeholder:'输入你的评论',
        visitor: true
    });
</script>


  </div>

  <footer class="post-footer">
    <div class="post-meta">
       <time datetime="2021-10-25T14:16:30+08:00" itemprop="datePublished">Oct 25, 2021</time> 
      
    </div>

    
    <ul class="post-tags" aria-label="TagList">
      
      <li><a class="tag-link" href="/tags/Python">Python</a></li>
      
      <li><a class="tag-link" href="/tags/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B">函数式编程</a></li>
      
      <li><a class="tag-link" href="/tags/%E7%B1%BB%E5%9E%8B">类型</a></li>
      
      <li><a class="tag-link" href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1">面向对象</a></li>
      
    </ul>
    
  </footer>

  
  
  

</article>

    </div>
    <script type="text/javascript">
  (function () {
    var resize = function () {
      this.width = 0.5 * (this.naturalWidth || this.width);
    }
    Array.prototype.forEach.call(document.querySelectorAll(".half-size, .retina2x"), function(el) {
      if (el.naturalWidth) {
        resize.call(el);
      } else {
        el.onload = resize;
      }
    });
  })();
</script>

    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script type="text/javascript">
  (function () {
    mermaid.init({ startOnLoad: true }, "pre code.language-mermaid", function () {
      const codeBlock = document.querySelector('code.language-mermaid');
      codeBlock.style.backgroundColor = 'initial';

      const preBlock = codeBlock.parentNode;
      preBlock.style.border = 'none';
      preBlock.style.textAlign = 'center';
      preBlock.style.backgroundColor = 'initial';
    });
  })();
</script>
    
  </main>

  <footer class="site-footer">

  <div class="wrapper">
    <div class="social-links">
      <a class="social-link social-github" href="https://github.com/threecifanggen">
        <i class="icon-github"></i>
      </a>
      <a class="social-link social-twitter" href="https://twitter.com/">
        <i class="icon-twitter"></i>
      </a>
      <a class="social-link social-instagram" href="https://instagram.com/threecifanggen">
        <i class="icon-instagram"></i>
      </a>
      <a class="social-link social-rss" href="/feed.xml" target="_blank">
        <i class="icon-rss"></i>
      </a>
    </div>
    <div class="credits">
      KAGAMI, made with <i class="icon-heart"></i> by Kamikat
    </div>
  </div>

</footer>


  <script>
  (function(elements) {
    var elements = Array.prototype.slice.call(document.getElementsByClassName('baseline-fix'));
    for (var i = 0; i != elements.length; i++) {
      var el = elements[i];
      el.innerHTML = el.innerHTML.replace(/[\u2000-\u206e⸀-\u2e7e⺀-\u2efe⼀-\u2fde⿰-\u2ffe\u3000-〾\u3040-ゞ゠-ヾ\u3100-\u312e\u3130-ㆎ㆐-㆞ㆠ-\u31be㇀-\u31eeㇰ-ㇾ㈀-㋾㌀-㏾㐀-\u4dbe一-\u9ffe\ua960-\ua97e가-\ud7ae\ud7b0-\ud7fe豈-\ufafe︰-﹎\uff00-￮]|[\ud840-\ud868\ud86a-\ud86c][\udc00-\udfff]|\ud82c[\udc00-\udcfe]|\ud869[\udc00-\udede\udf00-\udfff]|\ud86d[\udc00-\udf3e\udf40-\udfff]|\ud86e[\udc00-\udc1e]|\ud87e[\udc00-\ude1e]/g, function (ch) {
        return '<span class="baseline-fix-block">' + ch + '<' + '/span>';
      });
      el.classList.remove('baseline-fix');
    }
  })(Array.prototype.slice.call(document.getElementsByClassName('baseline-fix')));
</script>


</body>

</html>
