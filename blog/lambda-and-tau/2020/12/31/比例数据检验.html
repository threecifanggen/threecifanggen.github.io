<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>比例数据AB测试 - 3Gee的博客</title>
  <meta name="description" content="在实际业务中，我们经常会遇到频率类事件的假设检验，这类数据包括：留存率、点击率、转化率。我们甚至可以把大多数AB测试类的场景都理解为「频率的假设检验」。本文试图创建一个一般性的频率假设检验工具的EXCEL实现，并介绍其工作原理。文件参考这里。">

  
  <link rel="stylesheet" href="/assets/styles/core.css?v=20220111135546">
  <link rel="stylesheet" href="/assets/styles/fontello.css?v=20220111135546">
  <link rel="stylesheet" href="/assets/styles/highlighting/murphy.css?v=20220111135546">

  <link rel="canonical" href="https://3gee.netlify.app/lambda-and-tau/2020/12/31/%E6%AF%94%E4%BE%8B%E6%95%B0%E6%8D%AE%E6%A3%80%E9%AA%8C.html">
  <link rel="alternate" type="application/rss+xml" title="3Gee的博客" href="/feed.xml">

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
  <style>.MathJax_ExBox { font-family: serif; }</style>
  

  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56025474-3', 'auto');
  ga('send', 'pageview');

</script>
  

  
</head>

  <body>

  <main class="page-content" aria-label="Content">
    <div class="wrapper">
      <article class="post" lang="en" itemscope itemtype="http://schema.org/BlogPosting" >

  <header class="post-header">
  <a class="site-title" href="/">3Gee的博客</a>
  <h1 class="post-title baseline-fix" itemprop="name headline">比例数据AB测试</h1>
</header>




  <div class="post-content" itemprop="articleBody">
    <p>在实际业务中，我们经常会遇到频率类事件的假设检验，这类数据包括：留存率、点击率、转化率。我们甚至可以把大多数AB测试类的场景都理解为「频率的假设检验」。本文试图创建一个一般性的频率假设检验工具的EXCEL实现，并介绍其工作原理。文件参考<a href="https://github.com/threecifanggen/data-science-tools/blob/master/excel/%E4%BA%8C%E9%A1%B9%E5%88%86%E5%B8%83%E6%A3%80%E9%AA%8C.xlsx">这里</a>。</p>

<h2 id="定义问题">定义问题</h2>

<p>其实，在具体工作中，我们都会遇到比例数据来作为指标衡量一个数据，可以大致将这些指标抽象成三类数据：<strong>正事件触发次数/用户数</strong>，<strong>触发正事件的人数/人数</strong>，<strong>正事件触发次数/总事件发生次数</strong>。我们在文章中将以「平均发生次数」(Average Count)、「转化率」(Transfer Rate)、「发生率」(Positive Rate)来表述这三类指标。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">名称</th>
      <th style="text-align: center">平均发生次数</th>
      <th style="text-align: center">转化率</th>
      <th style="text-align: center">发生率</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">例子</td>
      <td style="text-align: center">人均成单量、人均点击量</td>
      <td style="text-align: center">留存率、成单转化率</td>
      <td style="text-align: center">按钮点击率、流程退出率</td>
    </tr>
    <tr>
      <td style="text-align: center">定义</td>
      <td style="text-align: center">正事件触发次数/用户数</td>
      <td style="text-align: center">触发正事件的人数/用户数</td>
      <td style="text-align: center">正事件触发次数/总时间发生次数</td>
    </tr>
    <tr>
      <td style="text-align: center">建议场景</td>
      <td style="text-align: center">单次触发具有实际意义;<br />和收入相关的内容; <br />较为综合的衡量产品的指标</td>
      <td style="text-align: center">与用户运营相关的指标；<br />评价用户粘性</td>
      <td style="text-align: center">判断某个功能好坏;<br />与产品细节优化相关</td>
    </tr>
    <tr>
      <td style="text-align: center">数据分布</td>
      <td style="text-align: center">指数分布为主，小概率为泊松分布</td>
      <td style="text-align: center">二项分布(Beta分布)</td>
      <td style="text-align: center">二项分布(Beta分布)</td>
    </tr>
  </tbody>
</table>

<h3 id="问题抽象">问题抽象</h3>

<p>事实上，我们单纯从数学抽象上说，上面的比例数据，事实上可以抽象为两类问题，一个是「每个用户具有一个观测量」，比例事实上反应的是这个观测量的平均值；另一类则是「频率」，反应的是一个事件发生的概率（只是这个频率的维度是以事件为主还是用户为主）。我们本文就限定在「频率」这个抽象问题的范围内，考虑如何比较两组频率的差异。理解了这个抽象，我们可以同时分析次留、转化率、AB测试的数据。特别的，我们采用的统计工具在以下场合，会比直接比较两组的频率更有效：</p>

<ol>
  <li>当抽样<strong>数据过小</strong>时或极度<strong>不平衡</strong>时。譬如在产品仅在冷启动时期，这时候的流量相对较小，单纯比较频率容易有抽样误差；</li>
  <li>快速决策的时候，特别地，需要<strong>决定何时终止</strong>比较的时候。譬如，在每单位时间成本极大的时候，如果进行AB测试，需要很快得到结果，终止测试。如果使用直接比较频率，我们往往无法做出何时终止测试的判断，下面的方法（特别是基于贝叶斯的方法）可以很快地在验证成功之后终止测试。</li>
</ol>

<h2 id="数学工具">数学工具</h2>

<p>首先，我们可以假设一个事件的发生频率为</p>

\[f = X/N\]

<p>其中， \(X\) 为正例发生次数，\(N\)则为事件发生总次数。譬如，在留存率（次留）中，\(X\)表示第二日使用产品的用户数，\(N\)表示计算当日的注册用户数。</p>

<p>我们很容易地可以做出假设：\(X\)属于二项分布，即：</p>

\[X \sim B(N, p)\]

<p>我们现在可以将其转化为两组二项数据的比较。</p>

<h3 id="方案一假设检验">方案一：假设检验</h3>

<p>这是最简单可以想到的方案。我们假设两组数据其参数分别为\(p_1\)，\(p_2\)。则可以建立如下假设：</p>

<ul>
  <li><strong>H0</strong>: \(p_1 = p_2\)</li>
  <li><strong>H1</strong>: \(p_1 \ne p_2\)</li>
</ul>

<p>则统计量\(z\) 满足</p>

\[z = \frac{\hat{p_1} - \hat{p_2}}{\sqrt{\hat{p}(1 - \hat{p})(\frac{1}{N_1} + \frac{1}{N_2})}}\]

<p>其中，\(\hat{p} = \frac{N_1\hat{p_1} + N_2\hat{p_2}}{N_1 + N_2}\)</p>

<p>因为\(z \sim N(0, 1)\)，我们就可以基于这个计算出相应的显著性值并进行比较。</p>

<p>可以在Excel的这部分看到结果，其中显著性大小我们这里分为<strong>0</strong>，<strong>**<em>， **</em></strong>*， <strong>**</strong>，<strong>***</strong>，<strong>****</strong>， <strong>*****</strong>五档，可以基于不同的数据量调整判断标准。</p>

<p><img src="https://typora-picgo-bed.oss-cn-beijing.aliyuncs.com/image-20210105112517589.png" alt="image-20210105112517589" /></p>

<h3 id="方案二-贝叶斯估计">方案二： 贝叶斯估计</h3>

<p>在大多数场合下，特别是指数分布族内的分布中，我们一般会使用\(Beta(\alpha, \beta)\)分布作为先验分布，当然这么选择会有很多好处，首先：</p>

<ol>
  <li>当\(\alpha\)，\(\beta\)足够大时，\(Beta(\alpha, \beta) \rightarrow B(\alpha + \beta, \frac{\alpha}{\alpha + \beta})\)。这样我们就可以刻画出以二项分布扩展的任何分布。</li>
  <li>其次，当先验分布为\(Beta(\alpha, \beta)\)，且新的观察量\(N\)中，有\(k\)个正例。则其后验分布可以算出为\(Beta(\alpha + k, \alpha + N - k)\)，计算非常简单。</li>
  <li>\(Beta(1, 1)\)为均匀分布，非常方便的可以作为无信息的先验分布。</li>
</ol>

<p>接下来，我们可以基于两组数据，来求出两个\(Beta\)分布，然后基于这两个\(Beta\)分布进行抽样，抽样的具体结果在Excel的这个位置：</p>

<p><img src="https://typora-picgo-bed.oss-cn-beijing.aliyuncs.com/image-20210105112617849.png" alt="image-20210105112617849" /></p>

<p>然后抽样结果的汇总数据，包括，每个例子的值还有分布，展示在这里：</p>

<p><img src="https://typora-picgo-bed.oss-cn-beijing.aliyuncs.com/image-20210105112714510.png" alt="image-20210105112714510" /></p>

<p>最后我们可以在这里看结果，这里提供以下指标，就是两个比例的抽样均值，还有就是给出两组数据之间差值正负的比例（\(P(A&gt;B)\)、\(P(B \ge A)\)这两项），差值的相关信息（包括平均数、方差、中位数）。基于这些量，我们就能很容易做出两组数据何者更好的</p>

<p><img src="https://typora-picgo-bed.oss-cn-beijing.aliyuncs.com/image-20210105112753093.png" alt="image-20210105112753093" /></p>

<h2 id="ab测试的一个动态推广">AB测试的一个动态推广</h2>

<blockquote>
  <p>示例可以参考<a href="https://github.com/threecifanggen/lambda-and-tau/blob/master/%E6%AF%94%E4%BE%8B%E6%95%B0%E6%8D%AE%E6%A3%80%E9%AA%8C/%E7%82%B9%E5%87%BB%E7%8E%87%E5%8A%A8%E6%80%81AB%E6%B5%8B%E8%AF%95%E7%A4%BA%E4%BE%8B.ipynb">这里</a></p>
</blockquote>

<p>AB测试的时候，我们很想很快知道测试结果，因为某些测试本身可能会影响到功能、收入等情况，这时候，我们就需要知道何时终止测试。而上面的贝叶斯的方案，可以给我们提供一个解决这一问题的发想。</p>

<p>首先，我们要把AB测试的数据结果看成两（或多）组时间序列数据，在快速测试时，我们可能使用按分钟的维度来监控这两组数据。譬如我们现在要测试两个按钮设计的点击率，则需要统计每一分组内，每个按钮点击次数和未点击次数，譬如生成下列数据，一个是0.62概率一个0.65，我们生成100个时间段的数据，且故意让两个数据很接近而且抽样非常不平均。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">binom</span><span class="p">,</span> <span class="n">beta</span>
<span class="kn">from</span> <span class="nn">plotnine</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">accumulate</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>


<span class="n">n1</span><span class="p">,</span> <span class="n">p1</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="mf">0.62</span>
<span class="n">n2</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="mf">0.65</span>
<span class="n">seed_a</span> <span class="o">=</span> <span class="n">binom</span><span class="p">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
<span class="n">seed_b</span> <span class="o">=</span> <span class="n">binom</span><span class="p">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>

<span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">sum</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">1</span><span class="p">),</span> <span class="nb">sum</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="p">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">seed_a</span><span class="p">,</span> <span class="mi">100</span><span class="p">)]</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">sum</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">1</span><span class="p">),</span> <span class="nb">sum</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="p">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">seed_b</span><span class="p">,</span> <span class="mi">100</span><span class="p">)]</span>
</code></pre></div></div>

<p>然后，我们主要通过\(max(P(p_a &gt; p_b), P(p_a \le p_b))\)，来判断是不是具有显著的差异。显然，当这个值越接近于1，表示这抽样数据里面两个组的数据有差别的可能性越大，我们就可以基于此来判断是否可以终止实验。核心的抽样算法实现如下，其中<code class="language-plaintext highlighter-rouge">beta.rvs(a, b, size=n)</code>就表示生成<code class="language-plaintext highlighter-rouge">n</code>个beta分布的数据。然后我们可以应用贝叶斯的方法，很快地随着每批数据进来快速地产生新的后验概率并基于此抽样。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">gennerate_avg</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">helper</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span>
            <span class="n">beta</span><span class="p">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">'a_x'</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s">'a_y'</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span> <span class="o">&gt;</span>
            <span class="n">beta</span><span class="p">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">'b_x'</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s">'b_y'</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
        <span class="k">return</span> <span class="n">res</span> <span class="k">if</span> <span class="n">res</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">res</span> <span class="k">else</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">res</span>
    <span class="k">return</span> <span class="n">helper</span>
</code></pre></div></div>

<p>最后，我们就可以实时地展示两幅图，来动态判断是不是有把握可以终止实验，做出判断了。第一幅是两个点击率随数据进来后，渐渐趋于稳定的比较图，这张图主要展示，此时a、b组点击率的变化。只有当a、b组点击率不发生明显波动时，我们才能做出判断。这个是防止我们过早地终止实验。其次，这张图也一定程度直观告诉我们，两个点击率哪个大哪个小。</p>

<p><img src="https://typora-picgo-bed.oss-cn-beijing.aliyuncs.com/image-20210105144846253.png" alt="image-20210105144846253" /></p>

<p>第二幅图则是\(max(P(p_a &gt; p_b), P(p_a \le p_b))\)的演化图，它衡量的是两组数具有差异的可能性。我们可以添加我们能容忍错误的可能性，比如下图的绿线表示我们的容忍底线0.999，即我们保证抽样的99.9%的数据都显示出有一组大于另一组的差异时，我们就可以终止实验了。比如次例子中，我们大致在第60分钟时，就可以终止实验，而不需要积累大量数据。</p>

<p><img src="https://typora-picgo-bed.oss-cn-beijing.aliyuncs.com/image-20210105150006274.png" alt="image-20210105150006274" /></p>

<div id="comments"></div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>

<script src="//unpkg.com/valine/dist/Valine.min.js"></script>

<script>
    new Valine({
        el: '#comments',
        app_id: 'qrAQjOGaeAWqza9Eb2aLJBg8-gzGzoHsz',
        app_key: 'UYnglEGtJuNEqBaQwYmH8cPY',
        placeholder:'输入你的评论',
        visitor: true
    });
</script>


  </div>

  <footer class="post-footer">
    <div class="post-meta">
       <time datetime="2020-12-31T12:05:53+08:00" itemprop="datePublished">Dec 31, 2020</time> 
      
    </div>

    
    <ul class="post-tags" aria-label="TagList">
      
      <li><a class="tag-link" href="/tags/AB%E6%B5%8B%E8%AF%95">AB测试</a></li>
      
      <li><a class="tag-link" href="/tags/%E5%B0%8F%E6%95%B0%E6%8D%AE">小数据</a></li>
      
    </ul>
    
  </footer>

  
  
  

</article>

    </div>
    <script type="text/javascript">
  (function () {
    var resize = function () {
      this.width = 0.5 * (this.naturalWidth || this.width);
    }
    Array.prototype.forEach.call(document.querySelectorAll(".half-size, .retina2x"), function(el) {
      if (el.naturalWidth) {
        resize.call(el);
      } else {
        el.onload = resize;
      }
    });
  })();
</script>

    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script type="text/javascript">
  (function () {
    mermaid.init({ startOnLoad: true }, "pre code.language-mermaid", function () {
      const codeBlock = document.querySelector('code.language-mermaid');
      codeBlock.style.backgroundColor = 'initial';

      const preBlock = codeBlock.parentNode;
      preBlock.style.border = 'none';
      preBlock.style.textAlign = 'center';
      preBlock.style.backgroundColor = 'initial';
    });
  })();
</script>
    
  </main>

  <footer class="site-footer">

  <div class="wrapper">
    <div class="social-links">
      <a class="social-link social-github" href="https://github.com/threecifanggen">
        <i class="icon-github"></i>
      </a>
      <a class="social-link social-twitter" href="https://twitter.com/">
        <i class="icon-twitter"></i>
      </a>
      <a class="social-link social-instagram" href="https://instagram.com/threecifanggen">
        <i class="icon-instagram"></i>
      </a>
      <a class="social-link social-rss" href="/feed.xml" target="_blank">
        <i class="icon-rss"></i>
      </a>
    </div>
    <div class="credits">
      KAGAMI, made with <i class="icon-heart"></i> by Kamikat
    </div>
  </div>

</footer>


  <script>
  (function(elements) {
    var elements = Array.prototype.slice.call(document.getElementsByClassName('baseline-fix'));
    for (var i = 0; i != elements.length; i++) {
      var el = elements[i];
      el.innerHTML = el.innerHTML.replace(/[\u2000-\u206e⸀-\u2e7e⺀-\u2efe⼀-\u2fde⿰-\u2ffe\u3000-〾\u3040-ゞ゠-ヾ\u3100-\u312e\u3130-ㆎ㆐-㆞ㆠ-\u31be㇀-\u31eeㇰ-ㇾ㈀-㋾㌀-㏾㐀-\u4dbe一-\u9ffe\ua960-\ua97e가-\ud7ae\ud7b0-\ud7fe豈-\ufafe︰-﹎\uff00-￮]|[\ud840-\ud868\ud86a-\ud86c][\udc00-\udfff]|\ud82c[\udc00-\udcfe]|\ud869[\udc00-\udede\udf00-\udfff]|\ud86d[\udc00-\udf3e\udf40-\udfff]|\ud86e[\udc00-\udc1e]|\ud87e[\udc00-\ude1e]/g, function (ch) {
        return '<span class="baseline-fix-block">' + ch + '<' + '/span>';
      });
      el.classList.remove('baseline-fix');
    }
  })(Array.prototype.slice.call(document.getElementsByClassName('baseline-fix')));
</script>


</body>

</html>
